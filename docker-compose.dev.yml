services:
    db:
        image: postgres:16-alpine
        container_name: website-db-dev
        restart: always
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-postgres}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
            POSTGRES_DB: ${POSTGRES_DB:-website}
        ports:
            - '5444:5432'
        volumes:
            - postgres_data_dev:/var/lib/postgresql/data

    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile.dev
        container_name: website-backend-dev
        depends_on:
            - db
        volumes:
            # Mount source code so edits are visible
            - ./backend:/app
            # Cache build artifacts in a volume (faster, avoids recompiling deps)
            - backend_target:/app/target
            # Cache cargo registry (avoids re-downloading crates)
            - cargo_registry:/usr/local/cargo/registry
        environment:
            - RUST_LOG=debug
            - SERVER_PORT=8888
            - DATABASE_URL=postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@db:5432/${POSTGRES_DB:-website}
            - UPSTREAM_COC_API_URL=${UPSTREAM_COC_API_URL}
            - COC_BOT_API_TOKEN=${COC_BOT_API_TOKEN}
            - UPSTREAM_CR_API_URL=${UPSTREAM_CR_API_URL}
            - CR_BOT_API_TOKEN=${CR_BOT_API_TOKEN}
            - CLASH_OF_CLANS_API_TOKEN=${CLASH_OF_CLANS_API_TOKEN}
            - CLASH_ROYALE_API_TOKEN=${CLASH_ROYALE_API_TOKEN}
            - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
            - DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}
            - DISCORD_REDIRECT_URI=${DISCORD_REDIRECT_URI}
            - JWT_SECRET=${JWT_SECRET}
            - FRONTEND_URL=${FRONTEND_URL}
        ports:
            - '8888:8888'

    website:
        build:
            context: ./website
            dockerfile: Dockerfile.dev
        container_name: website-frontend-dev
        depends_on:
            - backend
        volumes:
            # Mount source code
            - ./website:/app
            # Use an anonymous volume for node_modules so the container's installed deps
            # aren't overwritten by the host's (potentially empty or incompatible) node_modules
            - /app/node_modules
        ports:
            - '5173:5173'

volumes:
    backend_target:
    cargo_registry:
    postgres_data_dev:
